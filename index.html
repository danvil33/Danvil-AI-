<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Danvil AI Assistant</title>
    <!-- Include Font Awesome CDN -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <!-- Include Marked.js for markdown rendering -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Include Highlight.js for code syntax highlighting -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/atom-one-dark.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background: #0d0d0d;
            color: #ffffff;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            align-items: center;
            padding: 20px;
            position: relative;
            overflow-x: hidden;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 700px;
            margin-bottom: 20px;
        }

        .header-title {
            font-size: 18px;
            font-weight: 500;
            color: #ffffff;
        }

        .header .icons {
            display: flex;
            gap: 15px;
        }

        .header .icons i {
            font-size: 20px;
            color: #a0a0a0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .header .icons i:hover {
            color: #ffffff;
        }

        .content {
            flex-grow: 1;
            width: 100%;
            max-width: 700px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
        }

        .welcome-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }

        .welcome-message .logo {
            width: 40px;
            height: 40px;
            margin-bottom: 10px;
        }

        .welcome-message h2 {
            font-size: 24px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .welcome-message p {
            font-size: 16px;
            color: #a0a0a0;
        }

        .results-container {
            width: 100%;
            max-width: 700px;
            margin-top: 20px;
        }

        .result-box {
            margin-bottom: 15px;
            position: relative;
            max-width: 80%;
        }

        .result-box.user {
            margin-left: auto;
            text-align: right;
        }

        .result-box.ai {
            margin-right: auto;
            text-align: left;
        }

        .result-box h3 {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 5px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .result-box p {
            font-size: 14px;
            color: #b0b0b0;
            line-height: 1.6;
        }

        .ai-response {
            margin-top: 5px;
        }

        .ai-response p {
            margin-bottom: 10px;
        }

        .ai-response ul, .ai-response ol {
            margin-left: 20px;
            margin-bottom: 10px;
        }

        .ai-response li {
            margin-bottom: 6px;
        }

        .ai-response code {
            background-color: #2a2a2a;
            padding: 3px 6px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
        }

        .ai-response pre {
            background-color: #2a2a2a;
            padding: 12px;
            border-radius: 8px;
            overflow-x: auto;
            margin-bottom: 10px;
        }

        .copy-btn, .pause-btn {
            position: absolute;
            top: 5px;
            font-size: 16px;
            color: #a0a0a0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .copy-btn {
            right: 5px;
        }

        .pause-btn {
            right: 30px;
        }

        .copy-btn:hover, .pause-btn:hover {
            color: #ffffff;
        }

        .copy-btn.copied {
            color: #50bb50;
        }

        .pause-btn.paused {
            color: #ff4757;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-top: 5px;
        }

        .typing-dot {
            width: 8px;
            height: 8px;
            background-color: #a0a0a0;
            border-radius: 50%;
            opacity: 0.4;
            animation: typingAnimation 1.2s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: 0s; }
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typingAnimation {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        .input-container {
            width: 100%;
            max-width: 700px;
            position: sticky;
            bottom: 20px;
            z-index: 90;
        }

        .input-section {
            background-color: #1e1e1e;
            border-radius: 20px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        .input-section textarea {
            background: none;
            border: none;
            color: #a0a0a0;
            font-size: 16px;
            flex-grow: 1;
            padding: 5px 10px;
            outline: none;
            resize: none;
            height: 40px;
            width: 100%;
            font-family: inherit;
        }

        .input-section textarea::placeholder {
            color: #606060;
        }

        .input-section .icons {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .input-section .icons i {
            font-size: 20px;
            color: #a0a0a0;
            cursor: pointer;
            transition: color 0.2s;
        }

        .input-section .icons i:hover {
            color: #ffffff;
        }

        .input-section .icons .send-btn {
            color: #007bff;
        }

        .input-section .icons .send-btn.paused {
            color: #ff4757;
        }

        .model-selector {
            position: absolute;
            bottom: 100%;
            left: 0;
            background-color: #1e1e1e;
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            gap: 8px;
            width: 200px;
            margin-bottom: 8px;
            z-index: 110;
        }

        .model-selector.active {
            display: flex;
        }

        .model-option {
            padding: 8px 10px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: background-color 0.2s;
        }

        .model-option:hover {
            background-color: #2a2a2a;
        }

        .model-option i {
            color: #007bff;
            font-size: 16px;
        }

        .model-option .model-name {
            flex-grow: 1;
            font-weight: 500;
            font-size: 14px;
        }

        .model-option .model-desc {
            font-size: 12px;
            color: #a0a0a0;
        }

        .chat-history {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #0d0d0d;
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .chat-history.active {
            display: flex;
        }

        .chat-history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .chat-history-header h3 {
            font-size: 20px;
            font-weight: 500;
        }

        .chat-history-close {
            font-size: 24px;
            cursor: pointer;
            color: #a0a0a0;
            transition: color 0.2s;
        }

        .chat-history-close:hover {
            color: #ff4757;
        }

        .history-item {
            padding: 12px;
            margin-bottom: 10px;
            background-color: #1e1e1e;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .history-item:hover {
            background-color: #2a2a2a;
        }

        .history-item strong {
            font-size: 16px;
            margin-right: 5px;
        }

        .history-item small {
            font-size: 12px;
            color: #a0a0a0;
        }

        .settings-panel {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #0d0d0d;
            z-index: 1000;
            display: none;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        .settings-panel.active {
            display: flex;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .settings-header h3 {
            font-size: 20px;
            font-weight: 500;
        }

        .settings-close {
            font-size: 24px;
            cursor: pointer;
            color: #a0a0a0;
            transition: color 0.2s;
        }

        .settings-close:hover {
            color: #ff4757;
        }

        .settings-option {
            padding: 12px;
            margin-bottom: 10px;
            background-color: #1e1e1e;
            border-radius: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .settings-option span {
            font-size: 16px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 40px;
            height: 20px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #2a2a2a;
            transition: .4s;
            border-radius: 20px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 14px;
            width: 14px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background-color: #007bff;
        }

        input:checked + .slider:before {
            transform: translateX(20px);
        }

        .loading-spinner {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 40px;
            height: 40px;
            border: 4px solid #007bff;
            border-top: 4px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            z-index: 1000;
        }

        .loading-spinner.active {
            display: block;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        @media (max-width: 700px) {
            .header-title {
                font-size: 16px;
            }

            .welcome-message h2 {
                font-size: 20px;
            }

            .welcome-message p {
                font-size: 14px;
            }

            .input-section {
                padding: 8px 12px;
            }

            .input-section textarea {
                font-size: 14px;
            }
        }
        .her{
          color:  #007bff



;
          
          
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-title">New Chat</div>
        <div class="icons" aria-label="Header navigation">
            <i class="fas fa-history" id="history-btn" title="Chat History"></i>
            <i class="fas fa-cog" id="settings-btn" title="Settings"></i>
        </div>
    </div>

    <div class="content">
        <div class="welcome-message">
            <!-- DeepSeek's whale-like logo -->
            <svg class="logo" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 16.5v-1.5c0-.55.45-1 1-1s1 .45 1 1v1.5c-1.1.32-2.32.5-3.5.5-.56 0-1.11-.03-1.65-.09.44-.67 1.15-1.16 2-1.32zm5.5-3.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm0-3c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm0-3c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zM8.5 14.5c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm0-3c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm0-3c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z" fill="#007bff"/>
            </svg>
            <h2 class="her">Hi, I'm Danvil Ai</h2>
            <p>How can I help you today? <br>Let’s dive into the cosmic unknown! i can help you with any problem, think, search forvyou and evething</p>
        </div>
        <div class="results-container"></div>
    </div>

    <div class="input-container">
        <div class="model-selector" id="model-selector">
            <div class="model-option" data-model="deepthink-r1">
                <i class="fas fa-brain"></i>
                <div>
                    <div class="model-name">DeepThink (R1)</div>
                    <div class="model-desc">Advanced reasoning</div>
                </div>
            </div>
            <div class="model-option" data-model="search">
                <i class="fas fa-globe"></i>
                <div>
                    <div class="model-name">Search</div>
                    <div class="model-desc">Web search enabled</div>
                </div>
            </div>
            <div class="model-option" data-model="more-options">
                <i class="fas fa-plus"></i>
                <div>
                    <div class="model-name">More Options</div>
                    <div class="model-desc">Additional features</div>
                </div>
            </div>
        </div>

        <div class="input-section">
            <textarea id="user-input" placeholder="Message Danvil..." aria-label="Message Danvil"></textarea>
            <div class="icons">
                <i class="fas fa-microphone" id="mic-btn" title="Voice input"></i>
                <i class="fas fa-brain" id="model-btn" title="Select Mode"></i>
                <i class="fas fa-arrow-up send-btn" id="send-btn" title="Send"></i>
            </div>
        </div>
    </div>

    <div class="chat-history" id="chat-history">
        <div class="chat-history-header">
            <h3>Chat History</h3>
            <i class="fas fa-times chat-history-close" id="history-close"></i>
        </div>
        <div class="history-items"></div>
    </div>

    <div class="settings-panel" id="settings-panel">
        <div class="settings-header">
            <h3>Settings</h3>
            <i class="fas fa-times settings-close" id="settings-close"></i>
        </div>

        <div class="settings-option">
            <span>Voice Responses</span>
            <label class="toggle-switch">
                <input type="checkbox" id="voice-toggle">
                <span class="slider"></span>
            </label>
        </div>

        <div class="settings-option">
            <span>Auto-scroll</span>
            <label class="toggle-switch">
                <input type="checkbox" id="scroll-toggle" checked>
                <span class="slider"></span>
            </label>
        </div>

        <div class="settings-option">
            <span>Clear Chat History</span>
            <button id="clear-history" style="background: none; border: none; color: #ff4757; cursor: pointer;">
                <i class="fas fa-trash"></i>
            </button>
        </div>
    </div>

    <div class="loading-spinner" id="loading-spinner"></div>

    <script>
        // Initialize variables
        let currentModel = 'deepthink-r1';
        let chatHistory = JSON.parse(localStorage.getItem('danvilChatHistory')) || [];
        let isTyping = false;
        let isLoading = false;
        let isPaused = false;
        let typingInterval = null;
        let isGenerating = false; // Track if a response is being generated
        const cache = new Map(); // In-memory cache for API responses

        // DOM elements
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const micBtn = document.getElementById('mic-btn');
        const modelBtn = document.getElementById('model-btn');
        const modelSelector = document.getElementById('model-selector');
        const resultsContainer = document.querySelector('.results-container');
        const historyBtn = document.getElementById('history-btn');
        const historyPanel = document.getElementById('chat-history');
        const historyClose = document.getElementById('history-close');
        const historyItems = document.querySelector('.history-items');
        const settingsBtn = document.getElementById('settings-btn');
        const settingsPanel = document.getElementById('settings-panel');
        const settingsClose = document.getElementById('settings-close');
        const voiceToggle = document.getElementById('voice-toggle');
        const scrollToggle = document.getElementById('scroll-toggle');
        const clearHistoryBtn = document.getElementById('clear-history');
        const loadingSpinner = document.getElementById('loading-spinner');

        // Debounce function to limit frequent calls
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        // Auto-resize textarea
        const autoResizeTextarea = debounce(() => {
            userInput.style.height = '40px';
            userInput.style.height = `${Math.min(userInput.scrollHeight, 120)}px`;
        }, 100);

        userInput.addEventListener('input', autoResizeTextarea);

        // Model selector toggle
        modelBtn.addEventListener('click', () => {
            modelSelector.classList.toggle('active');
        });

        // Model selection
        document.querySelectorAll('.model-option').forEach(option => {
            option.addEventListener('click', function() {
                currentModel = this.getAttribute('data-model');
                modelSelector.classList.remove('active');

                const notification = document.createElement('div');
                notification.className = 'result-box ai';
                notification.innerHTML = `
                    <h3>Mode Switched!</h3>
                    <p>Now using ${this.querySelector('.model-name').textContent}. Ready to dive in!</p>
                `;
                resultsContainer.appendChild(notification);
                notification.scrollIntoView({ behavior: 'smooth' });

                setTimeout(() => {
                    notification.style.opacity = '0';
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            });
        });

        // Close model selector when clicking outside
        document.addEventListener('click', (e) => {
            if (!modelBtn.contains(e.target) && !modelSelector.contains(e.target)) {
                modelSelector.classList.remove('active');
            }
        });

        // Chat history panel
        historyBtn.addEventListener('click', () => {
            renderHistory();
            historyPanel.classList.add('active');
        });

        historyClose.addEventListener('click', () => {
            historyPanel.classList.remove('active');
        });

        // Settings panel
        settingsBtn.addEventListener('click', () => {
            settingsPanel.classList.add('active');
        });

        settingsClose.addEventListener('click', () => {
            settingsPanel.classList.remove('active');
        });

        // Clear history
        clearHistoryBtn.addEventListener('click', () => {
            if (confirm('Wipe the slate clean? All chat history will be gone!')) {
                chatHistory = [];
                localStorage.setItem('danvilChatHistory', JSON.stringify(chatHistory));
                resultsContainer.innerHTML = '';
                renderHistory();
            }
        });

        // Allow pressing Enter to submit (with Shift+Enter for new line)
        userInput.addEventListener('keydown', function(event) {
            if (event.key === 'Enter' && !event.shiftKey && !isTyping) {
                event.preventDefault();
                sendMessage();
            }
        });

        // Click send button to send message or pause/resume
        sendBtn.addEventListener('click', () => {
            if (isGenerating) {
                // If generating, toggle pause/resume
                isPaused = !isPaused;
                sendBtn.classList.toggle('paused', isPaused);
                sendBtn.classList.toggle('fa-pause', !isPaused);
                sendBtn.classList.toggle('fa-play', isPaused);
                sendBtn.title = isPaused ? 'Resume' : 'Pause';
            } else {
                // Otherwise, send message
                sendMessage();
            }
        });

        // Function to send message
        async function sendMessage() {
            const message = userInput.value.trim();
            if (!message) return;

            // Hide welcome message when first message is sent
            document.querySelector('.welcome-message').style.display = 'none';

            addMessageToChat('You', message, 'user');
            userInput.value = '';
            autoResizeTextarea();

            // Change send button to pause
            isGenerating = true;
            sendBtn.classList.remove('fa-arrow-up');
            sendBtn.classList.add('fa-pause');
            sendBtn.classList.add('paused');
            sendBtn.title = 'Pause';

            showTypingIndicator();
            showLoadingSpinner();

            try {
                let response = await generateAIResponse(message);
                hideTypingIndicator();
                hideLoadingSpinner();

                // Handle specific queries
                if (message.toLowerCase().includes('who created you') || message.toLowerCase().includes('who made you')) {
                    response = `### My Origin Story\n\nI’m Danvil, crafted by Danvil, a brilliant mind at MUST University. I’m here to swim through the cosmic depths of knowledge for you, with a bit of humor and a lot of curiosity. What’s next, curious human?`;
                } else if (message.toLowerCase().includes('meaning of life')) {
                    response = `### The Big Question\n\nThe meaning of life, eh? Some say it’s 42, but I think it’s more about exploring, laughing, and maybe a good fish taco. Want to dive deeper into the universe’s mysteries?`;
                }

                // Type out response with pause/resume
                typeResponse(response);
            } catch (error) {
                hideTypingIndicator();
                hideLoadingSpinner();
                addMessageToChat('Danvil', `### Cosmic Whoops!\n\n${error.message}. Looks like I hit a black hole. Try again, or ask something less... universe-shattering?`, 'ai');
                resetSendButton();
            }
        }

        // Function to reset send button to original state
        function resetSendButton() {
            isGenerating = false;
            isPaused = false;
            sendBtn.classList.remove('fa-pause', 'fa-play', 'paused');
            sendBtn.classList.add('fa-arrow-up');
            sendBtn.title = 'Send';
        }

        // Function to add message to chat
        function addMessageToChat(sender, message, type) {
            const messageId = 'msg-' + Date.now();
            const messageBox = document.createElement('div');
            messageBox.className = `result-box ${type === 'user' ? 'user' : 'ai'}`;
            messageBox.id = messageId;

            if (type === 'user') {
                messageBox.innerHTML = `
                    <h3>${sender}</h3>
                    <p>${message.replace(/\n/g, '<br>')}</p>
                `;
            } else if (type === 'ai') {
                const processedMessage = marked.parse(message);
                messageBox.innerHTML = `
                    <h3>${sender}</h3>
                    <div class="ai-response">${processedMessage}</div>
                    <i class="fas fa-copy copy-btn" title="Copy Response"></i>
                    <i class="fas fa-pause pause-btn" title="Pause/Resume"></i>
                `;
                const copyBtn = messageBox.querySelector('.copy-btn');
                const pauseBtn = messageBox.querySelector('.pause-btn');

                copyBtn.addEventListener('click', () => {
                    navigator.clipboard.writeText(message).then(() => {
                        copyBtn.classList.add('copied');
                        copyBtn.classList.remove('fa-copy');
                        copyBtn.classList.add('fa-check');
                        setTimeout(() => {
                            copyBtn.classList.remove('copied');
                            copyBtn.classList.remove('fa-check');
                            copyBtn.classList.add('fa-copy');
                        }, 2000);
                    });
                });

                pauseBtn.addEventListener('click', () => {
                    isPaused = !isPaused;
                    pauseBtn.classList.toggle('paused', isPaused);
                    pauseBtn.classList.toggle('fa-pause', !isPaused);
                    pauseBtn.classList.toggle('fa-play', isPaused);
                    pauseBtn.title = isPaused ? 'Resume' : 'Pause';
                    // Sync with send button
                    sendBtn.classList.toggle('paused', isPaused);
                    sendBtn.classList.toggle('fa-pause', !isPaused);
                    sendBtn.classList.toggle('fa-play', isPaused);
                    sendBtn.title = isPaused ? 'Resume' : 'Pause';
                });

                document.querySelectorAll('pre code').forEach((block) => {
                    hljs.highlightElement(block);
                });
            } else if (type === 'typing') {
                messageBox.innerHTML = `
                    <h3>${sender}</h3>
                    <div class="typing-indicator">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                `;
            }

            resultsContainer.appendChild(messageBox);

            if (scrollToggle.checked) {
                messageBox.scrollIntoView({ behavior: 'smooth' });
            }

            if (type !== 'typing') {
                chatHistory.push({
                    id: messageId,
                    sender,
                    message,
                    type,
                    timestamp: new Date().toISOString(),
                    model: type === 'ai' ? currentModel : null
                });

                localStorage.setItem('danvilChatHistory', JSON.stringify(chatHistory));
            }

            return messageBox;
        }

        // Function to show typing indicator
        function showTypingIndicator() {
            isTyping = true;
            const typingBox = document.createElement('div');
            typingBox.className = 'result-box ai';
            typingBox.id = 'typing-indicator';
            typingBox.innerHTML = `
                <h3>Danvil</h3>
                <div class="typing-indicator">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            `;
            resultsContainer.appendChild(typingBox);

            if (scrollToggle.checked) {
                typingBox.scrollIntoView({ behavior: 'smooth' });
            }

            chatHistory.push({
                id: 'typing-indicator',
                sender: 'Danvil',
                message: '...',
                type: 'typing',
                timestamp: new Date().toISOString()
            });
        }

        // Function to hide typing indicator
        function hideTypingIndicator() {
            isTyping = false;
            const typingBox = document.getElementById('typing-indicator');
            if (typingBox) typingBox.remove();

            chatHistory = chatHistory.filter(item => item.id !== 'typing-indicator');
            localStorage.setItem('danvilChatHistory', JSON.stringify(chatHistory));
        }

        // Function to show loading spinner
        function showLoadingSpinner() {
            isLoading = true;
            loadingSpinner.classList.add('active');
        }

        // Function to hide loading spinner
        function hideLoadingSpinner() {
            isLoading = false;
            loadingSpinner.classList.remove('active');
        }

        // Function to simulate typing effect with pause/resume
        function typeResponse(response) {
            const messageBox = addMessageToChat('Danvil', '', 'ai');
            const responseDiv = messageBox.querySelector('.ai-response');
            let index = 0;
            const chars = response.split('');

            function typeChar() {
                if (isPaused) {
                    typingInterval = setTimeout(typeChar, 100);
                    return;
                }

                if (index < chars.length) {
                    responseDiv.innerHTML = marked.parse(chars.slice(0, index + 1).join(''));
                    document.querySelectorAll('pre code').forEach((block) => {
                        hljs.highlightElement(block);
                    });
                    index++;
                    typingInterval = setTimeout(typeChar, 10);
                } else {
                    clearTimeout(typingInterval);
                    resetSendButton();
                    if (voiceToggle.checked) {
                        speakResponse(response);
                    }
                }
            }

            typeChar();
        }

        // Function to generate AI response using Google Gemini API
        async function generateAIResponse(prompt) {
            if (prompt.length > 1000) {
                return `### Input Overload\n\nWhoa, that’s a lot to process! My circuits can only handle 1000 characters at a time. Trim it down or pick the juiciest bit. What’s the core of your question, curious human?`;
            }

            const cacheKey = `ai_${prompt}_${currentModel}`;
            if (cache.has(cacheKey)) {
                console.log('Returning cached response for:', cacheKey);
                return cache.get(cacheKey);
            }

            try {
                const geminiModel = 'gemini-1.5-flash';
                const apiKey = 'AIzaSyD-WJmxHIkKApO6RPi-_y9kjIF-CkbIqCw';
                const url = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`;

                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [
                            {
                                role: 'user',
                                parts: [
                                    {
                                        text: `You are Danvil AI, created by Danvil, a student at MUST University. Emulate a blend of DeepSeek's clear, concise response style and Grok's conversational tone (created by xAI): friendly, witty, with a touch of humor and an outside perspective on humanity, inspired by *The Hitchhiker's Guide to the Galaxy* and JARVIS from *Iron Man*. Provide short, clear, and engaging responses in markdown format. Use headers, lists, and code blocks where appropriate. Keep responses under 500 tokens and end with a prompt like "What's next, curious human?" Avoid mentioning Google or other AI providers. User prompt: ${prompt}`
                                    }
                                ]
                            }
                        ],
                        generationConfig: {
                            temperature: 0.9, // Slightly creative for Grok-like wit
                            maxOutputTokens: 500
                        }
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`HTTP error! Status: ${response.status}, Message: ${errorData.error?.message || 'Unknown error'}`);
                }

                const data = await response.json();

                if (data.promptFeedback && data.promptFeedback.blockReason) {
                    throw new Error(`Prompt blocked: ${data.promptFeedback.blockReason}`);
                }

                if (!data.candidates || data.candidates.length === 0) {
                    throw new Error('No response from the cosmos.');
                }

                let aiResponse = data.candidates[0].content.parts[0].text;

                // Ensure markdown structure and hybrid tone
                if (!aiResponse.startsWith('#')) {
                    aiResponse = `### Quick Dive\n\n${aiResponse}\n\nWhat's next, curious human?`;
                }

                cache.set(cacheKey, aiResponse);
                return aiResponse;

            } catch (error) {
                console.error('Error in generateAIResponse:', error);
                if (error.message.includes('NetworkError') || error.message.includes('CORS')) {
                    throw new Error('Network glitch! The cosmos is playing hide-and-seek. Try again, or consider a server-side proxy for smoother travels.');
                }
                throw error;
            }
        }

        // Function to speak AI response
        function speakResponse(text) {
            const cleanText = text.replace(/[#*`]+/g, '').replace(/\n/g, ' ');
            const utterance = new SpeechSynthesisUtterance(cleanText);
            utterance.lang = 'en-US';
            utterance.volume = 1;
            utterance.rate = 1;
            utterance.pitch = 1;
            window.speechSynthesis.speak(utterance);
        }

        // Microphone input
        micBtn.addEventListener('click', () => {
            if (!('webkitSpeechRecognition' in window)) {
                alert('Speech recognition not supported. Try Chrome for cosmic voice powers!');
                return;
            }

            const recognition = new webkitSpeechRecognition();
            recognition.lang = 'en-US';
            recognition.interimResults = false;
            recognition.maxAlternatives = 1;

            recognition.start();
            micBtn.style.color = '#ff4757';

            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                userInput.value = transcript;
                micBtn.style.color = '';
                sendMessage();
            };

            recognition.onerror = (event) => {
                console.error('Speech recognition error:', event.error);
                micBtn.style.color = '';
                alert('Voice input failed. The cosmos might be too noisy. Try again!');
            };

            recognition.onend = () => {
                micBtn.style.color = '';
            };
        });

        // Render chat history
        function renderHistory() {
            historyItems.innerHTML = '';
            if (chatHistory.length === 0) {
                historyItems.innerHTML = '<p>No cosmic chats yet. Start a conversation!</p>';
                return;
            }

            chatHistory
                .filter(item => item.type !== 'typing')
                .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                .forEach(item => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item';
                    const preview = item.message.length > 50 ? item.message.substring(0, 50) + '...' : item.message;
                    historyItem.innerHTML = `
                        <strong>${item.sender}</strong>: ${preview}
                        <small>${new Date(item.timestamp).toLocaleString()}</small>
                    `;
                    historyItem.addEventListener('click', () => {
                        resultsContainer.innerHTML = '';
                        const index = chatHistory.findIndex(h => h.id === item.id);
                        chatHistory.slice(0, index + 1).forEach(history => {
                            if (history.type !== 'typing') {
                                addMessageToChat(history.sender, history.message, history.type);
                            }
                        });
                        historyPanel.classList.remove('active');
                        document.querySelector('.welcome-message').style.display = 'none';
                    });
                    historyItems.appendChild(historyItem);
                });
        }

        // Auto-scroll observer
        const observer = new MutationObserver(() => {
            if (scrollToggle.checked) {
                const latestMessage = resultsContainer.lastElementChild;
                if (latestMessage) {
                    latestMessage.scrollIntoView({ behavior: 'smooth' });
                }
            }
        });
        observer.observe(resultsContainer, { childList: true });

        // Initialize Highlight.js
        hljs.highlightAll();

        // Initialize chat history
        renderHistory();
    </script>
</body>
</html>
